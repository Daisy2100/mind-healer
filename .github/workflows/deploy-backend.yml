name: Deploy Mind Healer Backend
permissions:
  contents: read

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      GCP_VM_IP: ${{ vars.GCP_VM_IP }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker Image
        working-directory: ./backend
        run: |
          docker build -t mindhealer-backend:latest .

      - name: Save Docker Image to tar
        working-directory: ./backend
        run: |
          mkdir -p dist
          docker save -o dist/mindhealer-backend-$(date +%Y%m%d%H%M).tar mindhealer-backend:latest

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CICD_KEY }}

      - name: Install gcloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Enable Firewall Rule
        run: gcloud compute firewall-rules update allow-github-actions-ssh --no-disabled

      - name: Deploy to GCP VM via SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.GCP_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # 清除舊的 known_hosts 避免衝突
          rm -f ~/.ssh/known_hosts

          # 加入 GCP VM 公鑰到 known_hosts
          ssh-keyscan -H ${{ secrets.GCP_VM_IP }} >> ~/.ssh/known_hosts

          # SSH 測試連線
          ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i ~/.ssh/id_rsa daisy@${{ secrets.GCP_VM_IP }} "echo SSH OK" || exit 1

          # 上傳 Docker tar 檔案到 VM
          scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i ~/.ssh/id_rsa backend/dist/*.tar daisy@${{ secrets.GCP_VM_IP }}:${{ secrets.GCP_VM_PATH_BACKEND }}/ || exit 1

          # 在 VM 上載入 Docker image 並執行
          ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i ~/.ssh/id_rsa daisy@${{ secrets.GCP_VM_IP }} << 'ENDSSH'
            cd ${{ secrets.GCP_VM_PATH_BACKEND }}
            
            # 載入最新的 Docker image (使用 sudo)
            sudo docker load -i $(ls -t mindhealer-backend-*.tar | head -1)
            
            # 執行部署腳本
            sudo chmod +x run.sh
            sudo ./run.sh &
            
            # 等待容器啟動
            sleep 5
            
            # 檢查容器狀態
            sudo docker ps | grep mindhealer-backend || echo "Backend container may not be running"
            ENDSSH

      - name: Disable Firewall Rule
        if: always()
        run: |
          # 等待一下讓資源狀態穩定
          sleep 3
          
          # 重試機制關閉防火牆
          for i in {1..3}; do
            if gcloud compute firewall-rules update allow-github-actions-ssh --disabled; then
              echo "Firewall rule disabled successfully"
              break
            else
              echo "Attempt $i failed, retrying in 5 seconds..."
              sleep 5
            fi
          done
