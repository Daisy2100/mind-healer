name: Deploy Mind Healer Backend

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      GCP_VM_IP: ${{ vars.GCP_VM_IP }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker Image
        working-directory: ./backend
        run: |
          docker build -t mindhealer-backend:latest .

      - name: Save Docker Image to tar
        working-directory: ./backend
        run: |
          mkdir -p dist
          docker save -o dist/mindhealer-backend-$(date +%Y%m%d%H%M).tar mindhealer-backend:latest

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CICD_KEY }}

      - name: Install gcloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Enable Firewall Rule
        run: gcloud compute firewall-rules update allow-github-actions-ssh --no-disabled

      - name: Deploy to GCP VM via SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.GCP_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # 清除舊的 known_hosts 避免衝突
          rm -f ~/.ssh/known_hosts

          # 加入 GCP VM 公鑰到 known_hosts
          ssh-keyscan -H ${{ secrets.GCP_VM_IP }} >> ~/.ssh/known_hosts

          # SSH 測試連線
          ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i ~/.ssh/id_rsa daisy@${{ secrets.GCP_VM_IP }} "echo SSH OK" || exit 1

          # 上傳 Docker tar 檔案到 VM
          scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i ~/.ssh/id_rsa backend/dist/*.tar daisy@${{ secrets.GCP_VM_IP }}:${{ secrets.GCP_VM_PATH_BACKEND }}/ || exit 1

          # 上傳 run.sh 和 .env (如果存在)
          scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i ~/.ssh/id_rsa backend/run.sh daisy@${{ secrets.GCP_VM_IP }}:${{ secrets.GCP_VM_PATH_BACKEND }}/ || exit 1
          
          # 上傳 .env 檔案 (如果存在的話，否則忽略錯誤)
          scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i ~/.ssh/id_rsa backend/.env daisy@${{ secrets.GCP_VM_IP }}:${{ secrets.GCP_VM_PATH_BACKEND }}/ 2>/dev/null || echo ".env not found, skipping"

          # 在 VM 上載入 Docker image 並執行
          ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i ~/.ssh/id_rsa daisy@${{ secrets.GCP_VM_IP }} << 'ENDSSH'
            cd ${{ secrets.GCP_VM_PATH_BACKEND }}
            
            # 載入最新的 Docker image
            docker load -i $(ls -t mindhealer-backend-*.tar | head -1)
            
            # 執行部署腳本
            sudo chmod +x run.sh
            sudo ./run.sh
          ENDSSH

      - name: Disable Firewall Rule
        if: always()
        run: gcloud compute firewall-rules update allow-github-actions-ssh --disabled
